<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>微嶼 | 線上訂房</title>
    <!-- ===== 載入統一樣式 ===== -->
    <th:block th:replace="~{fragments/fragments :: styles}"></th:block>
    <!-- flatpickr 日期區間選擇器 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>
</head>
<body>
<!-- ===== 載入Header ===== -->
<div th:replace="~{fragments/fragments :: header}"></div>

<main>
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <h2>線上訂房</h2>
                <div class="booking_form clearfix">
                    <form name="idForm" id="idForm" action="/booking/search" method="post">
                        <input type="hidden" name="showPromotions" value="3">
                        <input type="hidden" name="language" value="zh">
                        <input type="hidden" name="locale" value="zh_HK">
                        <input type="hidden" name="FSTBKNGTrackLink" value="CUST-FBCN">
                        <input type="hidden" name="Clusternames" value="">
                        <input type="hidden" name="Hotelnames" value="ASIATWHTLGrandCosmos">
                        <input type="hidden" name="frommonth" id="frommonth">
                        <input type="hidden" name="fromday" id="fromday">
                        <input type="hidden" name="fromyear" id="fromyear">
                        <input type="hidden" name="tomonth" id="tomonth">
                        <input type="hidden" name="today" id="today">
                        <input type="hidden" name="toyear" id="toyear">
                        <input type="hidden" name="adulteresa" id="adulteresa">
                        <input type="hidden" name="enfantresa" id="enfantresa">
                        <input type="hidden" name="roomCount" id="roomCount" value="1">
                        <input type="hidden" name="roomAdults" id="roomAdults">
                        <input type="hidden" name="children" id="children">
                        <!-- 日期選擇 -->
                        <div class="mb-3">
                            <label for="main-date-range" class="form-label">入住/退房日期</label>
                            <input type="text" class="form-control" id="main-date-range" placeholder="請選擇入住與退房日期"
                              value="" required>
                            <input type="hidden" name="checkin" id="checkin" value="">
                            <input type="hidden" name="checkout" id="checkout" value="">
                        </div>
                        <!-- 人數選擇 -->
                        <div class="mb-3 d-flex gap-2">
                            <select class="form-select" id="main-adults" name="mainAdults" style="max-width: 120px;">
                                <option value="1" th:selected="${roomAdults != null and #lists.size(roomAdults) > 0 and roomAdults[0] == 1}">1 位成人</option>
                                <option value="2" th:selected="${roomAdults != null and #lists.size(roomAdults) > 0 and roomAdults[0] == 2}">2 位成人</option>
                                <option value="3" th:selected="${roomAdults != null and #lists.size(roomAdults) > 0 and roomAdults[0] == 3}">3 位成人</option>
                                <option value="4" th:selected="${roomAdults != null and #lists.size(roomAdults) > 0 and roomAdults[0] == 4}">4 位成人</option>
                                <option value="5" th:selected="${roomAdults != null and #lists.size(roomAdults) > 0 and roomAdults[0] == 5}">5 位成人</option>
                                <option value="6" th:selected="${roomAdults != null and #lists.size(roomAdults) > 0 and roomAdults[0] == 6}">6 位成人</option>
                            </select>
                            <select class="form-select" id="main-children" name="children" style="max-width: 120px;">
                                <option value="0" th:selected="${children == 0}">0 位孩童</option>
                                <option value="1" th:selected="${children == 1}">1 位孩童</option>
                                <option value="2" th:selected="${children == 2}">2 位孩童</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- 左側：房型列表 -->
            <div class="col-lg-8 col-md-7">
                <div th:each="roomTypeObj : ${availableRooms}" class="mb-4 p-3 border rounded">
                    <div class="row">
                        <!-- 房型圖片 -->
                        <div class="col-md-3">
                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:150px;">
                                <span class="text-muted">無圖片</span>
                            </div>
                        </div>
                        <!-- 房型資訊 -->
                        <div class="col-md-9">
                            <h5 th:text="${roomTypeObj.roomType.roomTypeName}">房型名稱</h5>
                            <p th:text="${roomTypeObj.roomType.roomTypeContent}">房型說明</p>
                            <!-- 促銷方案區塊 -->
                            <div class="row">
                                <div class="col-12 col-md-6 col-lg-4 mb-2" th:each="promo : ${roomTypeObj.promotions}">
                                    <div class="p-2 bg-light rounded d-flex justify-content-between align-items-center h-100">
                                        <div>
                                            <div class="fw-bold" th:text="${promo.title}">促銷名稱</div>
                                            <div th:if="${nightCount != null}">
                                                <span th:if="${promo.isOriginal}" class="text-primary"
                                                      th:text="${promo.price} + ' 元/晚 × ' + ${nightCount} + ' 晚 = ' + (promo.price * nightCount) + ' 元'"></span>
                                                <span th:if="${!promo.isOriginal}" class="text-success"
                                                      th:text="${promo.price} + ' 元/晚 × ' + ${nightCount} + ' 晚 = ' + (promo.price * nightCount) + ' 元'"></span>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-dark btn-select-room ms-2"
                                            th:attr="data-room-name=${roomTypeObj.roomType.roomTypeName},data-room-price=${promo.price},data-room-id=${roomTypeObj.roomType.roomTypeId},data-room-type-id=${roomTypeObj.roomType.roomTypeId},data-promotion-id=${promo.promotionId},data-promotion-title=${promo.title}"
                                            >選擇</button>
                                    </div>
                                </div>
                                <div class="col-12" th:if="${#lists.size(roomTypeObj.promotions) == 1}">
                                    <div class="p-2 bg-light rounded text-muted">無促銷</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右側：臨時購物車 -->
            <div class="col-lg-4 col-md-5">
                <div class="sticky-top" style="top: 80px;">
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-dark text-white">
                            <i class="bi bi-cart"></i> 訂房資訊
                        </div>
                        <div class="card-body" id="cart-list">
                            <div class="mb-2">
                                <div id="cart-date-range" class="fw-bold">-</div>
                                <div id="cart-summary" class="text-secondary">-</div>
                            </div>
                            <hr/>
                            <!-- 選擇的房型列表 -->
                            <div id="selected-rooms" class="mb-3">
                                <!-- 房型項目會動態插入這裡 -->
                            </div>
                            <hr/>
                            <div class="fw-bold">總價：<span class="text-primary" id="cart-total">0</span> 元</div>
                            <!-- 送出預訂按鈕 -->
                            <div class="mt-3" id="booking-button-container" style="display: none;">
                                <button type="button" class="btn btn-dark w-100" id="btn-submit-booking">
                                    <i class="bi bi-check-circle"></i> 送出預訂
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ========== 載入Footer ========== -->
<div th:replace="~{fragments/fragments :: footer}"></div>

<!-- 初始化 flatpickr -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('頁面載入完成');
        
        // 取得 Thymeleaf 傳來的查詢條件
        var checkin = /*[[${checkin}]]*/ '';
        var checkout = /*[[${checkout}]]*/ '';
        if (checkin) document.getElementById('checkin').value = checkin;
        if (checkout) document.getElementById('checkout').value = checkout;
        
        flatpickr("#main-date-range", {
            mode: "range",
            dateFormat: "Y-m-d",
            minDate: "today",
            locale: "zh_tw",
            onChange: function(selectedDates) {
                const adults = document.getElementById('main-adults').value;
                const children = document.getElementById('main-children').value;
                if (selectedDates.length === 2 && adults && parseInt(adults) > 0) {
                    document.getElementById('fromyear').value = selectedDates[0].getFullYear();
                    document.getElementById('frommonth').value = String(selectedDates[0].getMonth() + 1).padStart(2, '0');
                    document.getElementById('fromday').value = String(selectedDates[0].getDate()).padStart(2, '0');
                    document.getElementById('toyear').value = selectedDates[1].getFullYear();
                    document.getElementById('tomonth').value = String(selectedDates[1].getMonth() + 1).padStart(2, '0');
                    document.getElementById('today').value = String(selectedDates[1].getDate()).padStart(2, '0');
                    setTimeout(function() {
                        document.getElementById('idForm').requestSubmit();
                    }, 200);
                }
            }
        });
        
        // 人數有異動也自動查詢（需有日期）
        function tryAutoSubmit() {
            const dateRange = document.getElementById('main-date-range').value;
            const adults = document.getElementById('main-adults').value;
            if (dateRange && dateRange.split(' 至 ').length === 2 && adults && parseInt(adults) > 0) {
                setTimeout(function() {
                    document.getElementById('idForm').requestSubmit();
                }, 200);
            }
        }
        document.getElementById('main-adults').addEventListener('change', function() {
            document.getElementById('adulteresa').value = this.value;
            tryAutoSubmit();
        });
        document.getElementById('main-children').addEventListener('change', function() {
            document.getElementById('enfantresa').value = this.value;
            tryAutoSubmit();
        });
        
        // 預設填入人數
        document.getElementById('adulteresa').value = document.getElementById('main-adults').value;
        document.getElementById('enfantresa').value = document.getElementById('main-children').value;

        // 表單送出前驗證與自動填 hidden input
        document.getElementById('idForm').addEventListener('submit', function(e) {
            console.log('表單送出');
            
            // 檢查日期
            const dateRange = document.getElementById('main-date-range').value;
            // 檢查人數
            const adults = document.getElementById('main-adults').value;
            const children = document.getElementById('main-children').value;

            // 檢查日期格式（flatpickr range 會是 "yyyy-mm-dd 至 yyyy-mm-dd"）
            if (!dateRange || dateRange.split(' 至 ').length !== 2) {
                alert('請選擇入住與退房日期');
                e.preventDefault();
                return;
            }
            // 檢查人數
            if (!adults || isNaN(adults) || parseInt(adults) < 1) {
                alert('請選擇成人人數');
                e.preventDefault();
                return;
            }
            // 自動填 hidden input
            const dates = dateRange.split(' 至 ');
            document.getElementById('checkin').value = dates[0];
            document.getElementById('checkout').value = dates[1];
            // 只支援一間房，roomAdults 為單一成人數陣列
            const roomAdultsArr = [parseInt(adults)];
            document.getElementById('roomAdults').value = JSON.stringify(roomAdultsArr);
            document.getElementById('roomCount').value = 1;
            document.getElementById('children').value = children;
            // debug log
            console.log('送出 roomAdults:', document.getElementById('roomAdults').value);
            console.log('送出 children:', document.getElementById('children').value);
        });

        // 頁面載入時自動更新右側資訊
        if (typeof updateCartInfo === 'function') updateCartInfo();
        updateRoomTypePrices();
    });
</script>

<script>
// 臨時購物車功能
const cartList = document.getElementById('cart-list');
const cartCheckin = document.getElementById('cart-checkin');
const cartCheckoutDate = document.getElementById('cart-checkout-date');
const cartNights = document.getElementById('cart-nights');
const cartRooms = document.getElementById('cart-rooms');
const cartPersons = document.getElementById('cart-persons');
const cartTotal = document.getElementById('cart-total');
let cartRoomsArr = [];

// 日期格式化工具
function formatDateZh(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  if (isNaN(d)) return '-';
  const y = d.getFullYear() - 2000;
  const m = d.getMonth() + 1;
  const day = d.getDate();
  const week = ['日','一','二','三','四','五','六'][d.getDay()];
  return y + '年' + m + '月' + day + '日 週' + week;
}

function updateCartInfo() {
  // 取得入住/退房日期
  const checkin = document.getElementById('checkin').value;
  const checkout = document.getElementById('checkout').value;
  let nights = '-';
  let dateRangeText = '-';
  let persons = 0;
  let rooms = 0;
  if (checkin && checkout) {
    const d1 = new Date(checkin);
    const d2 = new Date(checkout);
    nights = Math.max(1, Math.round((d2-d1)/(1000*60*60*24)));
    dateRangeText = formatDateZh(checkin) + ' – ' + formatDateZh(checkout) + ' ' + nights + ' 晚';
    // 人數與房間數 - 改為累加所有選擇的房型
    rooms = cartRoomsArr.length;
    // 每間房預設為查詢條件的人數
    const adultsPerRoom = parseInt(document.getElementById('main-adults').value||0);
    const childrenPerRoom = parseInt(document.getElementById('main-children').value||0);
    persons = rooms * (adultsPerRoom + childrenPerRoom);
  }
  document.getElementById('cart-date-range').textContent = dateRangeText;
  document.getElementById('cart-summary').textContent = persons + ' 位賓客，' + rooms + ' 個房間';
  // 總價
  let total = 0;
  cartRoomsArr.forEach(room => total += parseInt(room.price||0));
  if (typeof nights === 'number' && nights > 0) {
    total = total * nights;
  }
  document.getElementById('cart-total').textContent = total;
}

function renderCart() {
    updateCartInfo();
    
    // 渲染選擇的房型列表
    const selectedRoomsContainer = document.getElementById('selected-rooms');
    const bookingButtonContainer = document.getElementById('booking-button-container');
    
    if (cartRoomsArr.length === 0) {
        selectedRoomsContainer.innerHTML = '<div class="text-muted text-center">尚未選擇房型</div>';
        bookingButtonContainer.style.display = 'none';
    } else {
        // 取得住宿夜數
        const checkin = document.getElementById('checkin').value;
        const checkout = document.getElementById('checkout').value;
        let nights = 1;
        if (checkin && checkout) {
            const d1 = new Date(checkin);
            const d2 = new Date(checkout);
            nights = Math.max(1, Math.round((d2-d1)/(1000*60*60*24)));
        }
        selectedRoomsContainer.innerHTML = cartRoomsArr.map(function(room, index) {
            const price = parseInt(room.price || 0);
            const subtotal = price * nights;
            return '<div class="border rounded p-2 mb-2">' +
                   '<div class="d-flex justify-content-between align-items-start">' +
                   '<div class="flex-grow-1">' +
                   '<div class="fw-bold small">' + room.name + '</div>' +
                   '<div class="text-primary">' + price + ' 元/晚 × ' + nights + ' 晚 = ' + subtotal + ' 元</div>' +
                   '</div>' +
                   '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRoom(' + index + ')">' +
                   '<i class="bi bi-x"></i>' +
                   '</button>' +
                   '</div>' +
                   '</div>';
        }).join('');
        bookingButtonContainer.style.display = 'block';
    }
}

function removeRoom(index) {
    cartRoomsArr.splice(index, 1);
    renderCart();
}

// 送出預訂按鈕事件處理
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        var submitButton = document.getElementById('btn-submit-booking');
        if (submitButton) {
            submitButton.addEventListener('click', function() {
                // 組 bookingData
                const checkin = document.getElementById('checkin').value;
                const checkout = document.getElementById('checkout').value;
                const adults = document.getElementById('main-adults').value;
                const children = document.getElementById('main-children').value;
                // 計算住宿夜數
                let nights = 1;
                if (checkin && checkout) {
                    const d1 = new Date(checkin);
                    const d2 = new Date(checkout);
                    nights = Math.max(1, Math.round((d2-d1)/(1000*60*60*24)));
                }
                // 計算總價
                let totalPrice = 0;
                cartRoomsArr.forEach(room => totalPrice += parseInt(room.price||0));
                totalPrice = totalPrice * nights;
                // bookingData
                const bookingData = {
                    checkin,
                    checkout,
                    adults,
                    children,
                    nights,
                    totalPrice,
                    selectedRooms: cartRoomsArr
                };
                sessionStorage.setItem('bookingData', JSON.stringify(bookingData));
                // 跳轉
                window.location.href = '/booking/form';
            });
        }
    }, 100);
});

document.querySelectorAll('.btn-select-room').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const roomName = this.getAttribute('data-room-name');
        const price = this.getAttribute('data-room-price');
        const roomId = this.getAttribute('data-room-id');
        const roomTypeId = this.getAttribute('data-room-type-id');
        const promotionId = this.getAttribute('data-promotion-id');
        const promotionTitle = this.getAttribute('data-promotion-title');
        cartRoomsArr.push({ name: roomName, price, roomId, roomTypeId, promotionId, promotionTitle });
        renderCart();
    });
});

// 當查詢條件變動時自動更新右側資訊
['checkin','checkout','main-adults','main-children'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('change', function() {
            updateCartInfo();
            updateRoomTypePrices();
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.prev-photo-btn, .next-photo-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var roomTypeId = btn.getAttribute('data-roomtype-id');
      var img = document.querySelector('img.roomtype-photo-manual[data-roomtype-id="' + roomTypeId + '"]');
      var photoIds = img.getAttribute('data-photo-ids').replace(/\[|\]|\s/g, '').split(',');
      var currentSrc = img.getAttribute('src');
      var currentIdx = photoIds.findIndex(function(id) {
        return currentSrc.includes('/' + id);
      });
      if (btn.classList.contains('prev-photo-btn')) {
        currentIdx = (currentIdx - 1 + photoIds.length) % photoIds.length;
      } else {
        currentIdx = (currentIdx + 1) % photoIds.length;
      }
      img.setAttribute('src', '/booking/roomTypePhoto/image/' + photoIds[currentIdx]);
    });
  });
});
</script>

<script>
// 房型價格動態顯示小計
function updateRoomTypePrices() {
  // 取得住宿夜數
  const checkin = document.getElementById('checkin').value;
  const checkout = document.getElementById('checkout').value;
  let nights = 1;
  if (checkin && checkout) {
    const d1 = new Date(checkin);
    const d2 = new Date(checkout);
    nights = Math.max(1, Math.round((d2-d1)/(1000*60*60*24)));
  }
  // 原價
  document.querySelectorAll('.room-type-price').forEach(function(span) {
    const price = parseInt(span.getAttribute('data-price'));
    span.textContent = price + ' 元/晚 × ' + nights + ' 晚 = ' + (price * nights) + ' 元';
  });
  // 優惠價
  document.querySelectorAll('.room-type-discounted').forEach(function(span) {
    const price = parseInt(span.getAttribute('data-discounted'));
    span.textContent = price + ' 元/晚 × ' + nights + ' 晚 = ' + (price * nights) + ' 元';
  });
  // 省下金額
  document.querySelectorAll('.room-type-saved').forEach(function(span) {
    const diff = parseInt(span.getAttribute('data-diff'));
    span.textContent = '省下 ' + (diff * nights) + ' 元';
  });
}
</script>
</body>
</html>

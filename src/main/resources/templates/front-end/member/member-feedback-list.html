<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-Hant">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>å¾®å¶¼ | Isle Villa</title>
    <!-- ===== è¼‰å…¥çµ±ä¸€æ¨£å¼ ===== -->
    <th:block th:replace="~{fragments/fragments :: styles}"></th:block>
    <style>
        .star-rating {
            display: inline-flex;
            flex-direction: row-reverse;
            font-size: 1.5rem;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            color: #ddd;
            cursor: pointer;
            padding: 0 2px;
            transition: color 0.2s;
        }

        .star-rating input:checked ~ label,
        .star-rating input:checked ~ label ~ label {
            color: #ffc107;
        }

        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }

        .no-orders-message {
            text-align: center;
            padding: 3rem 2rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .no-orders-message .icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
<!-- ===== è¼‰å…¥Header ===== -->
<div th:replace="~{fragments/fragments :: header}"></div>
<main>
    <div class="container py-5">
        <h1 class="text-center mb-4">æœƒå“¡å°ˆå€</h1>
        <div class="row">
            <!-- ===== è¼‰å…¥å´é‚Šæ¬„ ===== -->
            <div th:replace="~{fragments/fragments :: memberSidebar(activeTab='feedback')}"></div>
            <!-- å³å´å…§å®¹å€ -->
            <div class="col-md-9">
                <!-- è¼‰å…¥ä¸­é¡¯ç¤º -->
                <div id="loadingSpinner" class="card p-4 shadow-sm">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">æ­£åœ¨è¼‰å…¥å¯è©•åƒ¹çš„è¨‚å–®...</p>
                    </div>
                </div>

                <!-- æ²’æœ‰å¯è©•åƒ¹è¨‚å–®æ™‚é¡¯ç¤º -->
                <div id="noOrdersMessage" class="card p-4 shadow-sm" style="display: none;">
                    <div class="no-orders-message">
                        <div class="icon">ğŸ“</div>
                        <h3 class="text-muted">ç›®å‰æ²’æœ‰å¯è©•åƒ¹çš„è¨‚å–®</h3>
                        <p class="text-muted mb-3">
                            åªæœ‰ä¸€å€‹æœˆå…§çš„è¨‚å–®æ‰èƒ½é€²è¡Œè©•åƒ¹å“¦ï¼
                        </p>
                        <div class="mt-4">
                            <a href="/member/room/list" class="btn btn-outline-primary me-2">æŸ¥çœ‹æˆ‘çš„è¨‚å–®</a>
<!--                            <a href="/rooms" class="btn btn-primary">ç«‹å³é è¨‚</a>-->
                        </div>
                    </div>
                </div>

                <!-- è¼‰å…¥å¤±æ•—æ™‚é¡¯ç¤º -->
                <div id="errorMessage" class="card p-4 shadow-sm" style="display: none;">
                    <div class="no-orders-message">
                        <div class="icon text-danger">âš ï¸</div>
                        <h3 class="text-danger">è¼‰å…¥å¤±æ•—</h3>
                        <p class="text-muted mb-3">
                            ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚
                        </p>
                        <button class="btn btn-primary" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
                    </div>
                </div>

                <!-- å•å·è¡¨å–® -->
                <div id="feedbackFormContainer" class="card p-4 shadow-sm" style="display: none;">
                    <h3 class="mb-4 text-center">ä½å®¿é«”é©—è©•åƒ¹å•å·</h3>
                    <form id="feedbackForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="roomReservationId" class="form-label">è«‹é¸æ“‡è¨‚å–® <span class="text-danger">*</span></label>
                            <select class="form-select" id="roomReservationId" name="roomReservationId" required>
                                <option value="">-- è«‹é¸æ“‡ --</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ•´é«”è©•åƒ¹ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbOverallRating" value="5" id="overall5" required>
                                <label for="overall5">â˜…</label>
                                <input type="radio" name="fbOverallRating" value="4" id="overall4">
                                <label for="overall4">â˜…</label>
                                <input type="radio" name="fbOverallRating" value="3" id="overall3">
                                <label for="overall3">â˜…</label>
                                <input type="radio" name="fbOverallRating" value="2" id="overall2">
                                <label for="overall2">â˜…</label>
                                <input type="radio" name="fbOverallRating" value="1" id="overall1">
                                <label for="overall1">â˜…</label>
                            </div>
                        </div>

                        <!-- æ¨è–¦èˆ‡å¦ -->
                        <div class="mb-3">
                            <label class="form-label">æ˜¯å¦æ¨è–¦ï¼Ÿ <span class="text-danger">*</span></label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fbRecommend" value="1" required>
                                <label class="form-check-label">æ¨è–¦</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fbRecommend" value="0">
                                <label class="form-check-label">ä¸æ¨è–¦</label>
                            </div>
                        </div>

                        <!-- å†è¨ªæ„é¡˜ -->
                        <div class="mb-3">
                            <label class="form-label">å†è¨ªæ„é¡˜ <span class="text-danger">*</span></label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fbRevisit" value="1" required>
                                <label class="form-check-label">é¡˜æ„</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fbRevisit" value="0">
                                <label class="form-check-label">ä¸é¡˜æ„</label>
                            </div>
                        </div>

                        <!-- æ¥é§æœå‹™è©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">æ¥é§æœå‹™ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbShuttleRating" value="5" id="shuttle5" required>
                                <label for="shuttle5">â˜…</label>
                                <input type="radio" name="fbShuttleRating" value="4" id="shuttle4">
                                <label for="shuttle4">â˜…</label>
                                <input type="radio" name="fbShuttleRating" value="3" id="shuttle3">
                                <label for="shuttle3">â˜…</label>
                                <input type="radio" name="fbShuttleRating" value="2" id="shuttle2">
                                <label for="shuttle2">â˜…</label>
                                <input type="radio" name="fbShuttleRating" value="1" id="shuttle1">
                                <label for="shuttle1">â˜…</label>
                            </div>
                        </div>

                        <!-- æ¥å¾…æœå‹™è©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">æ¥å¾…æœå‹™ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbReceptionRating" value="5" id="reception5" required>
                                <label for="reception5">â˜…</label>
                                <input type="radio" name="fbReceptionRating" value="4" id="reception4">
                                <label for="reception4">â˜…</label>
                                <input type="radio" name="fbReceptionRating" value="3" id="reception3">
                                <label for="reception3">â˜…</label>
                                <input type="radio" name="fbReceptionRating" value="2" id="reception2">
                                <label for="reception2">â˜…</label>
                                <input type="radio" name="fbReceptionRating" value="1" id="reception1">
                                <label for="reception1">â˜…</label>
                            </div>
                        </div>

                        <!-- æˆ¿é–“è©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">æˆ¿é–“è©•åƒ¹ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbRoomRating" value="5" id="room5" required>
                                <label for="room5">â˜…</label>
                                <input type="radio" name="fbRoomRating" value="4" id="room4">
                                <label for="room4">â˜…</label>
                                <input type="radio" name="fbRoomRating" value="3" id="room3">
                                <label for="room3">â˜…</label>
                                <input type="radio" name="fbRoomRating" value="2" id="room2">
                                <label for="room2">â˜…</label>
                                <input type="radio" name="fbRoomRating" value="1" id="room1">
                                <label for="room1">â˜…</label>
                            </div>
                        </div>

                        <!-- è¨­æ–½è©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">è¨­æ–½è©•åƒ¹ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbFacilityRating" value="5" id="facility5" required>
                                <label for="facility5">â˜…</label>
                                <input type="radio" name="fbFacilityRating" value="4" id="facility4">
                                <label for="facility4">â˜…</label>
                                <input type="radio" name="fbFacilityRating" value="3" id="facility3">
                                <label for="facility3">â˜…</label>
                                <input type="radio" name="fbFacilityRating" value="2" id="facility2">
                                <label for="facility2">â˜…</label>
                                <input type="radio" name="fbFacilityRating" value="1" id="facility1">
                                <label for="facility1">â˜…</label>
                            </div>
                        </div>

                        <!-- ç’°å¢ƒè©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">ç’°å¢ƒè©•åƒ¹ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbEnvRating" value="5" id="env5" required>
                                <label for="env5">â˜…</label>
                                <input type="radio" name="fbEnvRating" value="4" id="env4">
                                <label for="env4">â˜…</label>
                                <input type="radio" name="fbEnvRating" value="3" id="env3">
                                <label for="env3">â˜…</label>
                                <input type="radio" name="fbEnvRating" value="2" id="env2">
                                <label for="env2">â˜…</label>
                                <input type="radio" name="fbEnvRating" value="1" id="env1">
                                <label for="env1">â˜…</label>
                            </div>
                        </div>

                        <!-- æ€§åƒ¹æ¯”è©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">æ€§åƒ¹æ¯”è©•åƒ¹ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbValueRating" value="5" id="value5" required>
                                <label for="value5">â˜…</label>
                                <input type="radio" name="fbValueRating" value="4" id="value4">
                                <label for="value4">â˜…</label>
                                <input type="radio" name="fbValueRating" value="3" id="value3">
                                <label for="value3">â˜…</label>
                                <input type="radio" name="fbValueRating" value="2" id="value2">
                                <label for="value2">â˜…</label>
                                <input type="radio" name="fbValueRating" value="1" id="value1">
                                <label for="value1">â˜…</label>
                            </div>
                        </div>

                        <!-- ç¶²ç«™ä½¿ç”¨è©•åƒ¹ -->
                        <div class="mb-3">
                            <label class="form-label">ç¶²ç«™ä½¿ç”¨ <span class="text-danger">*</span></label>
                            <div class="star-rating">
                                <input type="radio" name="fbWebsiteRating" value="5" id="website5" required>
                                <label for="website5">â˜…</label>
                                <input type="radio" name="fbWebsiteRating" value="4" id="website4">
                                <label for="website4">â˜…</label>
                                <input type="radio" name="fbWebsiteRating" value="3" id="website3">
                                <label for="website3">â˜…</label>
                                <input type="radio" name="fbWebsiteRating" value="2" id="website2">
                                <label for="website2">â˜…</label>
                                <input type="radio" name="fbWebsiteRating" value="1" id="website1">
                                <label for="website1">â˜…</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="fbCompliment" class="form-label">å¥½è©•å…§å®¹</label>
                            <textarea class="form-control" id="fbCompliment" name="fbCompliment" rows="3" placeholder="è«‹åˆ†äº«æ‚¨æ»¿æ„çš„ä½å®¿é«”é©—..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="fbSuggestion" class="form-label">å»ºè­°èˆ‡æ”¹é€²</label>
                            <textarea class="form-control" id="fbSuggestion" name="fbSuggestion" rows="3" placeholder="è«‹æä¾›æ‚¨çš„å¯¶è²´å»ºè­°..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="fbImage" class="form-label">ä¸Šå‚³ç…§ç‰‡ï¼ˆéå¿…å¡«ï¼‰</label>
                            <input type="file" class="form-control" id="fbImage" name="fbImage" accept="image/*">
                            <div class="form-text">æ”¯æ´ JPGã€PNG æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°ä¸è¶…é 5MB</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ˜¯å¦é¡˜æ„å…¬é–‹è©•è«–ï¼Ÿ <span class="text-danger">*</span></label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fbPublic" value="1" required>
                                <label class="form-check-label">å…¬é–‹</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="fbPublic" value="0">
                                <label class="form-check-label">ä¸å…¬é–‹</label>
                            </div>
                            <div class="form-text">å…¬é–‹çš„è©•è«–å°‡é¡¯ç¤ºåœ¨ç¶²ç«™ä¸Šä¾›å…¶ä»–æ—…å®¢åƒè€ƒ</div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5">æäº¤å•å·</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- ========== è¼‰å…¥Footer ========== -->
<footer th:replace="~{fragments/fragments :: footer}"></footer>

<script>
    // åˆå§‹åŒ–é é¢
    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableOrders();
    });

    function loadAvailableOrders() {
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        showElement('loadingSpinner');
        hideElement('noOrdersMessage');
        hideElement('errorMessage');
        hideElement('feedbackFormContainer');

        fetch('/api/member/room-reservations')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                hideElement('loadingSpinner');

                if (data.length === 0) {
                    // æ²’æœ‰å¯è©•åƒ¹çš„è¨‚å–®
                    showElement('noOrdersMessage');
                } else {
                    // æœ‰å¯è©•åƒ¹çš„è¨‚å–®ï¼Œé¡¯ç¤ºå•å·
                    populateOrderSelect(data);
                    showElement('feedbackFormContainer');
                }
            })
            .catch(error => {
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                hideElement('loadingSpinner');
                showElement('errorMessage');
            });
    }

    function populateOrderSelect(orders) {
        const select = document.getElementById('roomReservationId');
        // æ¸…ç©ºç¾æœ‰é¸é …
        select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';

        orders.forEach(order => {
            const option = document.createElement('option');
            option.value = order.roomReservationId;

            // æ ¼å¼åŒ–é¡¯ç¤ºæ–‡å­—
            const checkInDate = formatDate(order.checkInDate);
            const checkOutDate = order.actualCheckOutDate ?
                formatDate(order.actualCheckOutDate) :
                formatDate(order.checkOutDate);

            option.textContent = `è¨‚å–® #${order.roomReservationId}ï¼ˆ${checkInDate} ~ ${checkOutDate}ï¼‰`;
            select.appendChild(option);
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    function showElement(id) {
        document.getElementById(id).style.display = 'block';
    }

    function hideElement(id) {
        document.getElementById(id).style.display = 'none';
    }

    // è¡¨å–®æäº¤
    document.getElementById('feedbackForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;

        // ç¦ç”¨æäº¤æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æäº¤
        submitButton.disabled = true;
        submitButton.textContent = 'æäº¤ä¸­...';

        const formData = new FormData(this);

        fetch('/api/feedbacks', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    alert('å•å·æäº¤æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„å¯¶è²´æ„è¦‹ã€‚');
                    // é‡æ–°è¼‰å…¥é é¢æˆ–å°å‘å…¶ä»–é é¢
                    window.location.href = '/member/feedback/list';
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'æäº¤å¤±æ•—');
                    });
                }
            })
            .catch(error => {
                console.error('æäº¤å¤±æ•—:', error);
                alert('æäº¤å¤±æ•—ï¼š' + error.message);
            })
            .finally(() => {
                // æ¢å¾©æäº¤æŒ‰éˆ•
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            });
    });
</script>
</body>
</html>
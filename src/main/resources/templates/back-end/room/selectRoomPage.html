<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>房間管理</title>
<!-- ===== 載入統一樣式 ===== -->
<th:block th:replace="~{fragments/backFragments :: styles}"></th:block>
</head>
<body>
	<!-- ===== 載入sidebar ===== -->
	<!-- 插入手機版側邊欄 -->
	<th:block th:replace="~{fragments/backFragments :: mobileSidebar}"></th:block>
	<!-- 插入桌面版側邊欄 -->
	<div th:replace="~{fragments/backFragments :: sidebar}"></div>

	<main
		th:replace="~{fragments/backFragments :: mainContent(~{::myContent})}">
		<th:block th:fragment="myContent">

			<div class="card-header bg-transparent border-0 pt-4">
				<div class="d-flex justify-content-between align-items-center">
					<h4 class="card-title mb-0 fw-bold">
						<i class="bi bi-search me-2"></i>房間查詢
					</h4>
					<div class="d-flex gap-2 flex-wrap">
						<a th:href="@{/backend/room/addRoom}" class="btn btn-success">
							<i class="bi bi-plus-circle me-1"></i>新增房間
						</a>
					</div>
				</div>
			</div>

			<div class="card-body">
				<div class="alert alert-info d-flex align-items-center mb-4"
					role="alert">
					<i class="bi bi-info-circle me-2"></i>
					<div>
						<strong>提示：</strong>可以使用單一條件或組合條件進行查詢，留空的欄位將不作為查詢條件。
					</div>
				</div>

				<div th:if="${successMessage}" class="alert alert-success"
					id="successMessage" role="alert">
					<span th:text="${successMessage}"></span>
				</div>
				<div th:if="${errorMessage}" class="alert alert-danger"
					id="errorMessage" role="alert">
					<ul class="mb-0">
						<li th:each="msg : ${errorMessage}" th:text="${msg}"></li>
					</ul>
				</div>

				<form id="roomForm" th:action="@{/backend/room/selectRoomPage}"
					method="post" novalidate data-validate-mode="loose">
					<div class="row g-3 align-items-end mb-4">
						<div class="col-md-4">
							<label for="roomId" class="form-label"> <i
								class="bi bi-door-open me-1"></i>房間ID
							</label> <input type="number" class="form-control"
								placeholder="請輸入房間ID（例如：501、510）" name="roomId" id="roomId">
						</div>
						<div class="col-md-4">
							<label for="roomTypeId" class="form-label"> <i
								class="bi bi-house me-1"></i>房型
							</label> <select name="roomTypeId" id="roomTypeId" class="form-select">
								<option value="">請選擇房型</option>
								<option th:each="roomTypeList : ${roomTypeList}"
									th:value="${roomTypeList.roomTypeId}"
									th:text="${roomTypeList.roomTypeName}"></option>
							</select>
						</div>
						<div class="col-md-4">
							<label for="roomStatus" class="form-label"> <i
								class="bi bi-flag me-1"></i>房間狀態
							</label> <select name="roomStatus" id="roomStatus" class="form-select">
								<option value="">請選擇房間狀態</option>
								<option th:each="roomStatus : ${roomStatusMap}"
									th:value="${roomStatus.key}" th:text="${roomStatus.value}">
								</option>
							</select>
						</div>
					</div>

					<div class="d-flex justify-content-end gap-2 flex-wrap">
						<button type="button" class="btn btn-outline-secondary"
							onclick="resetForm()">
							<i class="bi bi-arrow-clockwise me-1"></i>重置
						</button>
						<button type="submit" class="btn btn-success">
							<i class="bi bi-search me-1"></i>查詢
						</button>
					</div>
				</form>
				
				<div class="table-responsive">
                  <table class="table table-striped table-hover">
	                  <thead class="table-dark">
		                  <tr>
			                  <th>房間ID</th>
			                  <th>房型ID</th>
			                  <th>房型名稱</th>
			                  <th>房間狀態</th>
			                  <th>修改</th>
			                  <th>刪除</th>
		                  </tr>
	                  </thead>
	              	  <tbody> 
	                    <tr th:each="room : ${roomList}">
						      <td th:text="${room.roomId}">房間ID</td>
						      <td th:text="${room.roomTypeId}">房型ID</td>
						      <td th:text="${roomTypeNameMap[room.roomTypeId]}">房型名稱</td>
						      <td th:text="${roomStatusMap[room.roomStatus]}">房間狀態</td>
	                      <td>
                      		<a th:href="@{/backend/room/updateRoom/{roomId}(roomId=${room.roomId})}" class="btn btn-primary btn-sm">
								    <i class="bi bi-pencil"></i> 修改
								</a>
	                      </td>
	                      <td>
	                      	<a href="javascript:void(0);"
								class="btn btn-danger btn-sm"
								th:onclick="deleteRoom([[${room.roomId}]])"> 
								<i class="bi bi-trash"></i> 刪除
							</a></td>
						    </tr>
				    </tbody>
				  </table>
              	</div>
			</div>
		</th:block>
	</main>

	<!-- ===== 載入統一的 JavaScript ===== -->
	<th:block th:replace="~{fragments/backFragments :: scripts}"></th:block>
	<script src="/js/room.js"></script>
    <script>
	//JavaScript 發送 fetch 刪除請求並接收後端訊息
	function deleteRoom(roomId) {
	    if (!confirm('確定要刪除這個房間嗎？')) {
	        return;
	    }
	
	    fetch('/backend/room/deleteRoom/' + roomId, {
	        method: 'GET',
	    }).then(response => {
	        if (response.ok) {
	            // 從定向的URL中取得成功或失敗的訊息
	            const redirectUrl = response.url;
	            const urlParams = new URLSearchParams(new URL(redirectUrl).search);
	            const successMessage = urlParams.get('successMessage');
	            const errorMessage = urlParams.get('errorMessage');

	            if (successMessage) {
	                alert('刪除成功');
	            } else if (errorMessage) {
	                alert('刪除失敗：' + decodeURIComponent(errorMessage));
	            }
	            window.location.reload();
	        } else {
	            response.text().then(text => {
	                alert('刪除失敗：' + text);
	            });
	        }
	    }).catch(error => {
	        console.error('刪除時發生錯誤:', error);
	        alert('刪除時發生錯誤');
	    });
	}
	</script>
</body>
</html>
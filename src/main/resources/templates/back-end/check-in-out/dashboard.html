<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>微嶼 | Isle Villa 後台首頁</title>
    <!-- ===== 載入統一樣式 ===== -->
    <th:block th:replace="~{fragments/backFragments :: styles}"></th:block>
</head>
<body>
<!-- ===== 載入sidebar ===== -->
<!-- 插入手機版側邊欄 -->
<div th:replace="~{fragments/backFragments :: mobileSidebar}"></div>
<!-- 插入桌面版側邊欄 -->
<div th:replace="~{fragments/backFragments :: sidebar}"></div>

<main th:replace="~{fragments/backFragments :: mainContent(~{::myContent})}">
    <th:block th:fragment="myContent">
        <!-- //////////////////// 頁面內容放在這個card裡面//////////////////// -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">住房管理</h1>
        </div>

        <!-- 快速操作區域 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-house-check"></i> 辦理入住
                    </div>
                    <div class="card-body">
                        <form th:action="@{/admin/checkin}" method="post" id="checkinForm">
                            <div class="mb-3">
                                <label for="checkinOrderId" class="form-label">訂房編號</label>
                                <input type="number" class="form-control" id="checkinOrderId" name="roomRVOrderId"
                                       placeholder="請輸入訂房編號" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-check-circle"></i> 確認入住
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-house-x"></i> 辦理退房
                    </div>
                    <div class="card-body">
                        <form th:action="@{/admin/checkout}" method="post" id="checkoutForm">
                            <div class="mb-3">
                                <label for="checkoutOrderId" class="form-label">訂房編號</label>
                                <input type="number" class="form-control" id="checkoutOrderId" name="roomRVOrderId"
                                       placeholder="請輸入訂房編號" required>
                            </div>
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-x-circle"></i> 確認退房
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 訂單查詢功能 -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-search"></i> 訂單查詢
            </div>
            <div class="card-body">
                <form th:action="@{/admin/search-order}" method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="searchOrderId" class="form-label">訂房編號</label>
                        <input type="number" class="form-control" id="searchOrderId" name="orderId"
                               th:value="${searchOrderId}" placeholder="輸入訂房編號">
                    </div>
                    <div class="col-md-4">
                        <label for="searchStatus" class="form-label">訂單狀態</label>
                        <select class="form-select" id="searchStatus" name="status" th:value="${searchStatus}">
                            <option value="">全部狀態</option>
                            <option value="0" th:selected="${searchStatus == '0'}">成立</option>
                            <option value="1" th:selected="${searchStatus == '1'}">已入住</option>
                            <option value="2" th:selected="${searchStatus == '2'}">已退房</option>
                            <option value="3" th:selected="${searchStatus == '3'}">申請取消</option>
                            <option value="4" th:selected="${searchStatus == '4'}">確認取消</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> 查詢
                        </button>
                        <a href="/admin/checkin-checkout" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 訂單列表 -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> 訂房訂單列表
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>訂房編號</th>
                            <th>會員編號</th>
                            <th>訂單日期</th>
                            <th>狀態</th>
                            <th>入住日期</th>
                            <th>退房日期</th>
                            <th>優惠專案</th>
                            <!--                            <th>實際入住時間</th>-->
                            <!--                            <th>實際退房時間</th>-->
                            <th>總金額</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order : ${orderList}" th:if="${orderList != null}">
                            <td th:text="${order.roomReservationId}">1001</td>
                            <td th:text="${order.members.memberId}">M001</td>
                            <td th:text="${#temporals.format(order.roomOrderDate, 'yyyy-MM-dd HH:mm')}">2024-01-15
                                14:30
                            </td>
                            <td>
                                            <span th:switch="${order.roomOrderStatus}">
                                                <span th:case="0" class="badge bg-primary">成立</span>
                                                <span th:case="1" class="badge bg-success">已入住</span>
                                                <span th:case="2" class="badge bg-secondary">已退房</span>
                                                <span th:case="3" class="badge bg-warning">申請取消</span>
                                                <span th:case="4" class="badge bg-danger">確認取消</span>
                                            </span>
                            </td>
                            <td th:text="${#temporals.format(order.checkInDate, 'yyyy-MM-dd')}">2024-01-20</td>
                            <td th:text="${#temporals.format(order.checkOutDate, 'yyyy-MM-dd')}">2024-01-22</td>
                            <!--                            <td th:text="${order.actualCheckInDate != null ? #temporals.format(order.actualCheckInDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>-->
                            <!--                            <td th:text="${order.actualCheckOutDate != null ? #temporals.format(order.actualCheckOutDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>-->
                            <td th:text="${order.promotion != null ? order.promotion.roomPromotionTitle : '-'}">
                                -
                            </td>
                            <td th:text="'$' + ${order.rvPaidAmount}">$3000</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <!-- 查看詳情按鈕 -->
                                    <button type="button"
                                            class="btn btn-sm btn-info view-detail-btn"
                                            th:data-order-id="${order.roomReservationId}"
                                            title="查看詳情">
                                        <i class="bi bi-eye"></i>
                                    </button>

                                    <!-- 入住按鈕 -->
                                    <button th:if="${order.roomOrderStatus == 0}"
                                            type="button"
                                            class="btn btn-sm btn-success checkin-btn"
                                            th:data-order-id="${order.roomReservationId}"
                                            title="辦理入住">
                                        <i class="bi bi-house-check"></i>
                                    </button>

                                    <!-- 退房按鈕 -->
                                    <button th:if="${order.roomOrderStatus == 1}"
                                            type="button"
                                            class="btn btn-sm btn-warning checkout-btn"
                                            th:data-order-id="${order.roomReservationId}"
                                            title="辦理退房">
                                        <i class="bi bi-house-x"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${orderList == null or #lists.isEmpty(orderList)}">
                            <td colspan="10" class="text-center text-muted">目前沒有訂單資料</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 操作結果提示 -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-check-circle"></i>
            <span th:text="${message}">操作成功</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}">操作失敗</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <!-- //////////////////// 頁面內容放在這個card裡面//////////////////// -->
    </th:block>
</main>
</div>
</div>

<!-- 訂單詳情模態視窗 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">訂單詳情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- 詳情內容將透過AJAX載入 -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 確認操作模態視窗 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">確認操作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                您確定要執行此操作嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAction">確認</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 入住按鈕事件
        document.querySelectorAll('.checkin-btn').forEach(button => {
            button.addEventListener('click', function () {
                const orderId = this.getAttribute('data-order-id');
                showConfirmModal('辦理入住', `確定要為訂單 #${orderId} 辦理入住嗎？`, function () {
                    submitAction('/admin/checkin', orderId);
                });
            });
        });

        // 退房按鈕事件
        document.querySelectorAll('.checkout-btn').forEach(button => {
            button.addEventListener('click', function () {
                const orderId = this.getAttribute('data-order-id');
                showConfirmModal('辦理退房', `確定要為訂單 #${orderId} 辦理退房嗎？`, function () {
                    submitAction('/admin/checkout', orderId);
                });
            });
        });

        // 查看詳情按鈕事件
        document.querySelectorAll('.view-detail-btn').forEach(button => {
            button.addEventListener('click', function () {
                const orderId = this.getAttribute('data-order-id');
                showOrderDetail(orderId);
            });
        });

        // 表單驗證
        document.getElementById('checkinForm').addEventListener('submit', function (e) {
            const orderId = document.getElementById('checkinOrderId').value;
            if (!orderId || orderId <= 0) {
                e.preventDefault();
                alert('請輸入有效的訂房編號');
            }
        });

        document.getElementById('checkoutForm').addEventListener('submit', function (e) {
            const orderId = document.getElementById('checkoutOrderId').value;
            if (!orderId || orderId <= 0) {
                e.preventDefault();
                alert('請輸入有效的訂房編號');
            }
        });
    });

    function showConfirmModal(title, message, confirmCallback) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').textContent = message;

        const confirmButton = document.getElementById('confirmAction');
        confirmButton.onclick = function () {
            confirmCallback();
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        };

        new bootstrap.Modal(document.getElementById('confirmModal')).show();
    }

    function submitAction(action, orderId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = action;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'roomRVOrderId';
        input.value = orderId;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    function showOrderDetail(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        document.getElementById('orderDetailContent').innerHTML = '';
        fetch(`/admin/order-detail/${orderId}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById('orderDetailContent').innerHTML = html;
            });

        modal.show();
    }

    // 自動隱藏alert訊息
    setTimeout(function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.classList.contains('show')) {
                bootstrap.Alert.getOrCreateInstance(alert).close();
            }
        });
    }, 5000);
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>微嶼 | Isle Villa 後台首頁</title>
    <!-- ===== 載入統一樣式 ===== -->
    <th:block th:replace="~{fragments/backFragments :: styles}"></th:block>
</head>
<body>
<!-- ===== 載入sidebar ===== -->
<!-- 插入手機版側邊欄 -->
<div th:replace="~{fragments/backFragments :: mobileSidebar}"></div>
<!-- 插入桌面版側邊欄 -->
<div th:replace="~{fragments/backFragments :: sidebar}"></div>

<main th:replace="~{fragments/backFragments :: mainContent(~{::myContent})}">
    <th:block th:fragment="myContent">
        <!-- //////////////////// 頁面內容放在這個card裡面//////////////////// -->
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">住房管理</h1>
        </div>

        <!-- 快速操作區域 -->
        <div class="row mb-4">
            <!-- 入住區塊 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-house-check"></i> 辦理入住
                    </div>
                    <div class="card-body">
                        <form id="checkinForm" method="post"
                              th:action="@{/backend/room-reservation/{orderId}/checkin(orderId=${checkinOrderId})}"
                              onsubmit="return confirmCheckin();">
                            <div class="mb-3">
                                <label for="checkinOrderId" class="form-label">訂房編號</label>
                                <input type="number" class="form-control" id="checkinOrderId" name="checkinOrderId"
                                       placeholder="請輸入訂房編號" required oninput="updateCheckinAction(this.value)">
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-check-circle"></i> 確認入住
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 退房區塊 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-house-x"></i> 辦理退房
                    </div>
                    <div class="card-body">
                        <form id="checkoutForm" method="post"
                              th:action="@{/backend/room-reservation/{orderId}/checkout(orderId=${checkoutOrderId})}"
                              onsubmit="return confirmCheckout();">
                            <div class="mb-3">
                                <label for="checkoutOrderId" class="form-label">訂房編號</label>
                                <input type="number" class="form-control" id="checkoutOrderId" name="checkoutOrderId"
                                       placeholder="請輸入訂房編號" required oninput="updateCheckoutAction(this.value)">
                            </div>
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-x-circle"></i> 確認退房
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 訂單列表 -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> 訂房訂單列表
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>訂房編號</th>
                            <th>會員編號</th>
                            <th>訂單日期</th>
                            <th>狀態</th>
                            <th>入住日期</th>
                            <th>退房日期</th>
                            <th>優惠專案</th>
                            <!-- <th>實際入住時間</th> -->
                            <!-- <th>實際退房時間</th> -->
                            <th>總金額</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order : ${orderList}" th:if="${orderList != null}">
                            <td th:text="${order.roomReservationId}">1001</td>
                            <td th:text="${order.members.memberId}">M001</td>
                            <td th:text="${#temporals.format(order.roomOrderDate, 'yyyy-MM-dd HH:mm')}">2024-01-15
                                14:30
                            </td>
                            <td>
                                <span th:switch="${order.roomOrderStatus}">
                                    <span th:case="0" class="badge bg-primary">成立</span>
                                    <span th:case="1" class="badge bg-success">已入住</span>
                                    <span th:case="2" class="badge bg-secondary">已退房</span>
                                    <span th:case="3" class="badge bg-warning">申請取消</span>
                                    <span th:case="4" class="badge bg-danger">確認取消</span>
                                </span>
                            </td>
                            <td th:text="${#temporals.format(order.checkInDate, 'yyyy-MM-dd')}">2024-01-20</td>
                            <td th:text="${#temporals.format(order.checkOutDate, 'yyyy-MM-dd')}">2024-01-22</td>
                            <!-- <td th:text="${order.actualCheckInDate != null ? #temporals.format(order.actualCheckInDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>-->
                            <!-- <td th:text="${order.actualCheckOutDate != null ? #temporals.format(order.actualCheckOutDate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>-->
                            <td th:text="${order.promotion != null ? order.promotion.roomPromotionTitle : '-'}">
                                -
                            </td>
                            <td th:text="'$' + ${order.rvPaidAmount}">$3000</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <!-- 查看詳情按鈕 -->
                                    <button type="button"
                                            class="btn btn-sm btn-info view-detail-btn"
                                            th:data-order-id="${order.roomReservationId}"
                                            title="查看詳情">
                                        <i class="bi bi-eye"></i>
                                    </button>

                                    <!-- 入住按鈕 -->
                                    <form th:action="@{/backend/room-reservation/{orderId}/checkin(orderId=${order.roomReservationId})}"
                                          method="post" th:if="${order.roomOrderStatus==0}" class="d-inline">
                                        <button type="submit"
                                                class="btn btn-sm btn-success"
                                                title="辦理入住"
                                                onclick="return confirm('確定為訂單 #'+this.form.action.split('/').pop()+'辦理入住？');">
                                            <i class="bi bi-house-check"></i>
                                        </button>
                                    </form>

                                    <!-- 退房按鈕 -->
                                    <form th:action="@{/backend/room-reservation/{orderId}/checkout(orderId=${order.roomReservationId})}"
                                          method="post" th:if="${order.roomOrderStatus==1}" class="d-inline">
                                        <button type="submit"
                                                class="btn btn-sm btn-warning"
                                                title="辦理退房"
                                                onclick="return confirm('確定為訂單 #'+this.form.action.split('/').pop()+'辦理退房？');">
                                            <i class="bi bi-house-x"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${orderList == null or #lists.isEmpty(orderList)}">
                            <td colspan="10" class="text-center text-muted">目前沒有訂單資料</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 操作結果提示 -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-check-circle"></i>
            <span th:text="${message}">操作成功</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <span th:text="${error}">操作失敗</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <!-- //////////////////// 頁面內容放在這個card裡面//////////////////// -->
    </th:block>
</main>

<!-- 訂單詳情模態視窗 -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">訂單詳情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailContent">
                <!-- 詳情內容透過AJAX載入 -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 確認操作模態視窗 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">確認操作</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                您確定要執行此操作嗎？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAction">確認</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        updateCheckinAction(document.getElementById('checkinOrderId').value);
        updateCheckoutAction(document.getElementById('checkoutOrderId').value);

        // 查看詳情按鈕事件
        document.querySelectorAll('.view-detail-btn').forEach(button => {
            button.addEventListener('click', function () {
                const orderId = this.getAttribute('data-order-id');
                showOrderDetail(orderId);
            });
        });
    });

    // 彈出確認操作的視窗
    function confirmCheckin() {
        const id = document.getElementById('checkinOrderId').value;
        if (!id || id <= 0) {
            alert('請輸入有效的訂房編號');
            return false;
        }
        return confirm(`確定要為訂單 #${id} 辦理入住嗎？`);
    }

    function confirmCheckout() {
        const id = document.getElementById('checkoutOrderId').value;
        if (!id || id <= 0) {
            alert('請輸入有效的訂房編號');
            return false;
        }
        return confirm(`確定要為訂單 #${id} 辦理退房嗎？`);
    }

    function showOrderDetail(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        document.getElementById('orderDetailContent').innerHTML = '';
        fetch(`/backend/order-detail/${orderId}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById('orderDetailContent').innerHTML = html;
            });

        modal.show();
    }

    function updateCheckinAction(orderId) {
        const form = document.getElementById('checkinForm');
        if (orderId && orderId > 0) {
            form.action = `/backend/room-reservation/${orderId}/checkin`;
        } else {
            form.action = '#'; // 或空字串防止送出錯誤
        }
    }

    function updateCheckoutAction(orderId) {
        const form = document.getElementById('checkoutForm');
        if (orderId && orderId > 0) {
            form.action = `/backend/room-reservation/${orderId}/checkout`;
        } else {
            form.action = '#';
        }
    }

    // 自動隱藏alert訊息
    setTimeout(function () {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.classList.contains('show')) {
                bootstrap.Alert.getOrCreateInstance(alert).close();
            }
        });
    }, 5000);
</script>
</body>
</html>